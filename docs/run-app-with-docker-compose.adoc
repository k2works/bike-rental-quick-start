:toc: left
:toclevels: 5
:sectnums:
:stem:
:source-highlighter: coderay

= Docker Compose を使用してアプリケーションをローカルで実行する

このステップでは、ローカル環境でアプリケーションをすべての必要なものと一緒に実行する方法を見ていきます。

これが単なるSpringBootアプリケーションであれば、IDEから実行するだけで済みます。しかし、私たちのアプリケーションは、メッセージ（コマンド、イベント、クエリ）をルーティング、保存、および配信するための外部のメッセージングインフラストラクチャに依存する必要があります。私たちの場合、Axon Server を使用します。これにより、メッセージをルーティングするためのメッセージブローカーとしてだけでなく、イベントソーシングベースのシステムでイベントを保存および取得するために最適化されたイベントストアとしても機能します。

Axon Server を手動でインストールして起動する必要がないように、Axon Server Docker イメージと SpringBoot のサポートを使用して Docker コンテナを起動します。このセクションでは、必要なすべてをワンクリックで実行するように構成する方法を学びます。

== 必要条件

必要なすべてを簡単に、IDEからワンクリック（またはショートカットキーの組み合わせ）で実行するために、Docker Compose と Docker イメージを使用して Axon Server を起動します。

システムにリンク： https://docs.docker.com/engine/[Docker Engine,role=external,window=_blank] がインストールされていることを確認してください。 あるいは、 https://docs.docker.com/engine/install/[Docker Engine をインストールする,role=external,window=_blank] こともできます。

== Docker Compose の設定

=== Docker Compose ディスクリプター

https://docs.docker.com/compose/[Docker Compose,role=external,window=_blank]は、必要なすべての Docker コンテナ、ネットワーク、ボリューム、およびインフラストラクチャからアプリケーションを実行するために必要なその他の特性を定義できるツールです。

たとえ 1 つの Docker イメージ（Axon Server）を実行するだけでも、Docker Compose はすべてを 1 つのコマンドで起動できるため便利です。

ここでは、Docker Compose 構成ファイルの作成を開始します。`root` プロジェクトに `compose.yaml` ファイルを作成し、次の内容を記述します：

[source,yaml]
.compose.yaml
----
services:
  axonserver:<.>
    image: 'axoniq/axonserver:latest'<.>
    environment:<.>
      - 'AXONIQ_AXONSERVER_STANDALONE=TRUE'
    ports:<.>
      - '8024:8024'<.>
      - '8124:8124'<.>
----
<.> axonserver のサービス名を定義します。これは Docker Desktop によって起動されたときのサービス名として使用されます。
<.> `axoniq/axonserver:latest` イメージは、パブリックdockerhubイメージリポジトリに公開されている最新の Axon Server の Docker イメージを指します。
<.> 環境プロパティ `AXONIQ_AXONSERVER_STANDALONE` を `TRUE` に設定して、初期構成を行わずに Axon Server が起動するようにします。
<.> 実行中の Docker コンテナからエクスポートされるポートを構成します：
<.> `8024` はブラウザから Axon Server コンソールにアクセスするためのデフォルトポートです。
<.> `8124` はアプリケーションによって使用される Axon Server の gRPC ポートです。

NOTE: YAML ファイルはタブとスペースに敏感です。正しいインデントを使用していることを確認してください。

このファイルができたら、コマンドラインから axon server イメージを実行できるはずです：

[,bash]
----
bike-rental-quick-start % docker-compose  up
[+] Running 1/0
 ✔ Container bike-rental-quick-start-axonserver-1  Created                                                                                                                             0.0s
Attaching to axonserver-1
...
----

サーバーを手動で起動することは望んでいないので、IDE からアプリケーションを実行するときに Docker コンテナが自動的に起動されるように、SpringBoot の Docker Compose サポートを構成します。
コンソールで ^C と入力してコンテナを停止し、次のセクションに進みます。

=== Docker Compose を実行するための SpringBoot サポートの構成

v3.1以降、アプリケーションの開始にリンクされた Docker Compose サービスの開始をサポートしています。
この機能を有効にするには、`root` プロジェクトの maven ディスクリプター `pom.xml` ファイルに次の依存関係を追加する必要があります：

[,kotlin]
./app/backend/bike-rental/rental/build.gradle.kts
----
	developmentOnly("org.springframework.boot:spring-boot-docker-compose")
----

この依存関係を追加したら、IDE からアプリケーションを直接実行することができます。SpringBoot は `compose.yaml` ファイルを検出し、そのファイルに記述された Docker コンテナを開始します。

== アプリケーションの実行

IDE からアプリケーションを実行します。SpringBoot が AxonServer の Docker イメージをダウンロードし、アプリケーションを起動する前に AxonServer を自動的に起動する様子がログに表示されるはずです：

[,console]
----
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.2.1)
 INFO --- [Rental Monolith] i.a.d.b.rental.RentalApplication         : Starting RentalApplication using Java 21 with PID 69132 (/Users/dgomezg/projects/axon/code-samples/bike-rental-quick-start/rental/target/classes started by dgomezg in /Users/dgomezg/projects/axon/code-samples/bike-rental-quick-start)
 INFO --- [Rental Monolith] i.a.d.b.rental.RentalApplication         : No active profile set, falling back to 1 default profile: "default"
 INFO --- [Rental Monolith] .s.b.d.c.l.DockerComposeLifecycleManager : Using Docker Compose file '/Users/dgomezg/projects/axon/code-samples/bike-rental-quick-start/compose.yaml'
 INFO --- [Rental Monolith] o.s.boot.docker.compose.core.DockerCli   :  Container bike-rental-quick-start-axonserver-1  Created
 INFO --- [Rental Monolith] o.s.boot.docker.compose.core.DockerCli   :  Container bike-rental-quick-start-axonserver-1  Starting
 INFO --- [Rental Monolith] o.s.boot.docker.compose.core.DockerCli   :  Container bike-rental-quick-start-axonserver-1  Started
 INFO --- [Rental Monolith] o.s.boot.docker.compose.core.DockerCli   :  Container bike-rental-quick-start-axonserver-1  Waiting
 INFO --- [Rental Monolith] o.s.boot.docker.compose.core.DockerCli   :  Container bike-rental-quick-start-axonserver-1  Healthy
 INFO --- [Rental Monolith] verDockerComposeConnectionDetailsFactory : Detected Axon Server container. To access the dashboard, visit http://127.0.0.1:8024
----

アプリケーションが起動した後、ブラウザを開いて `http://localhost:8024[,role=external,window=_blank]` にアクセスします。Axon Server ダッシュボードにアクセスできます。

右パネルの「Overview」ボタンをクリックすると、Axon Server インスタンスと接続されている `Rental Monolith` アプリケーションが表示されます。

image::images/AxonServer-Dashboard.png[Axon Server ダッシュボードのスクリーンショット。Axon Server インスタンスに接続されたレンタルアプリケーションを表示]

次のステップでは、システム内のすべてのバイクのリストを取得する機能を実装します。したがって、`Query Model` をいくつかのプロジェクションで実装する方法を見ていきます。