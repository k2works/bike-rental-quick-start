:toc: left
:toclevels: 5
:sectnums:
:stem:
:source-highlighter: coderay

= 新しいAxon Frameworkマルチプロジェクトの作成

サンプルアプリケーションのために、API定義とメッセージを含む `core-api` モジュールと、バイクレンタルアプリケーションのビジネスロジックを含む `rental` モジュールの2つのモジュールからなるマルチモジュールGradleプロジェクトを作成します。

== プロジェクト構造

レンタルモジュールは *モジュラーモノリス* として設計します。つまり、プロジェクトを1つにまとめ、後でモジュールを異なる部分に分割しやすくするために、ロジックコンポーネントを分離して保持します。
まず、新しいプロジェクトを作成し、ビジネスコードに集中できるようにするためのSpring BootとAxon Frameworkの依存関係を設定する必要があります。
次の構造を持つGradleプロジェクトを作成します：

[listing]
.バイクレンタルデモアプリケーションの構造
----
📂 app
  📂 bike-rental
    📂	core-api
      📂 src
        📂 main
          📂 java
             📦 io.axoniq.demo.bikerental.coreapi
      📄 build.gradle.kts
    📂 rental
      📂 src
        📂 main
          📂 java
             📦 io.axoniq.demo.bikerental.rental
      📄 build.gradle.kts
    📄 settings.gradle.kts
    📄 build.gradle.kts
----

== プロジェクトの作成

まず、新しいプロジェクトを作成します。次のコマンドを実行して、新しいプロジェクトを作成します：

[source,shell]
----
mkdir -p app/backend/bike-rental
cd app/backend/bike-rental
gradle init

Select type of build to generate:
  1: Application
  2: Library
  3: Gradle plugin
  4: Basic (build structure only)
Enter selection (default: Application) [1..4]

Select implementation language:
  1: Java
  2: Kotlin
  3: Groovy
  4: Scala
  5: C++
  6: Swift
Enter selection (default: Java) [1..6]

Enter target Java version (min: 7, default: 21):

Project name (default: bike-rental):

Select application structure:
  1: Single application project
  2: Application and library project
Enter selection (default: Single application project) [1..2] 2

Select build script DSL:
  1: Kotlin
  2: Groovy
Enter selection (default: Kotlin) [1..2]

Generate build using new APIs and behavior (some features may change in the next minor release)? (default: no) [yes, no]
----

マルチプロジェクトのサンプルアプリケーションが作成されるので、`core-api` と `rental` の2つのサブプロジェクトを追加して不要なファイルを削除します。

[source,shell]
----
spring init --package-name=io.axoniq.demo.bikerental.coreapi core-api
spring init --package-name=io.axoniq.demo.bikerental.rental rental
----

== ルートプロジェクトの設定

ルートプロジェクトの`settings.gradle.kts`ファイルです：
[source,kotlin]
----
rootProject.name = "bike-rental"
include("core-api", "rental")
----

ルートプロジェクトの `build.gradle.kts` ファイルです：
[source,kotlin]
----
plugins {
    java
}

allprojects {
    apply(plugin = "java")
    apply(plugin = "buildlogic.java-application-conventions")
    apply(plugin = "buildlogic.java-common-conventions")
    apply(plugin = "buildlogic.java-library-conventions")
}

subprojects {
    group = "io.axoniq.demo.bikerental"

    repositories {
        mavenCentral()
    }

    dependencies {
        testRuntimeOnly("org.junit.platform:junit-platform-launcher")
    }
}
----

== 各モジュールの設定
`core-api` モジュールの `settings.gradle` ファイルを削除して `build.gradle` のファイル名を `build.gradle.kts` に変更します。
`core-api` モジュールの `build.gradle.kts` ファイルです：

[source,kotlin]
----
plugins {
	id("org.springframework.boot") version "3.4.0"
	id("io.spring.dependency-management") version "1.1.6"
}

version = "0.0.1-SNAPSHOT"

java {
	toolchain {
		languageVersion.set(JavaLanguageVersion.of(21))
	}
}

dependencies {
	implementation("org.springframework.boot:spring-boot-starter")
	testImplementation("org.springframework.boot:spring-boot-starter-test")
}

tasks.named<Test>("test") {
	useJUnitPlatform()
}

tasks.withType<JavaCompile>().configureEach {
	options.compilerArgs.add("-parameters")
}
----

`rental` モジュールの `settings.gradle` ファイルを削除して `build.gradle` のファイル名を `build.gradle.kts` に変更します。
`rental` モジュールの `build.gradle.kts` ファイルです：

[source,kotlin]
----
plugins {
	id("org.springframework.boot") version "3.4.0"
	id("io.spring.dependency-management") version "1.1.6"
}

version = "0.0.1-SNAPSHOT"

java {
	toolchain {
		languageVersion.set(JavaLanguageVersion.of(21))
	}
}

dependencies {
	implementation("org.springframework.boot:spring-boot-starter")
	testImplementation("org.springframework.boot:spring-boot-starter-test")
	api(project(":core-api"))
}

tasks.named<Test>("test") {
	useJUnitPlatform()
}
----

`app` `list` `utilites` は不要なので削除します。

IDEは新しいプロジェクトをサブモジュールとして表示するはずです。

NOTE: IDEが新しいモジュールを検出しない場合は、プロジェクト構造を更新し、IDEのGradleプロジェクトを再読み込みする必要があるかもしれません。

プロジェクトが作成されたら、次のステップでAxon Frameworkをプロジェクトにブートストラップする方法を学びます。